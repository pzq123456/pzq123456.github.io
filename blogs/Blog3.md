# 关于简易的带有代码高亮功能的输入框探索
> - 2024/12/26 PAN

在实现本网站的终端过程中，我一直使用 Canvas 标签来渲染内容。但是， Canvas 标签的内容是不可选择和复制的。 当然，我也可以在 Canvas 实现选择区域的渲染，但是这样会增加很多复杂度。所以，我决定探索如何使用原生的输入框来实现代码高亮的功能。

## 1. 单层结构与光标丢失
我使用的是 highlight.js 来实现代码高亮的功能。这个库可以将输入文本转化为带有高亮的 HTML 文本。考虑到 HTML 元素存在 "editable" 属性，我想到：完全可以使用一个带有 "editable" 属性的 div 元素来实现代码高亮的功能。我只需要监听 div 元素的输入事件，然后将输入的文本转化为高亮的 HTML 文本，再将这个 HTML 文本插入到 div 元素中即可。

但是，光标丢失问题最终否定了这个方法。在插入高亮代码后，光标会自动回到 div 元素的最前面。且这个问题是由浏览器底层的行为引起的，无法通过 JavaScript 来解决。

## 2. 双层结构：渲染于输入解耦合
为了解决光标丢失问题，我决定使用双层结构。即，一个 div 元素用于渲染高亮的 HTML 文本，一个输入框用于输入文本。这样，输入框的光标问题就不会影响到高亮的 HTML 文本。

只要将输入层的文本大小及行间距与渲染层的文本大小及行间距保持一致，就可以实现输入与渲染的解耦合。这样，用户输入的文本会被实时转化为高亮的 HTML 文本，并显示在渲染层中。

这样做出来的效果基本达到了我的预期。但是，这种方法也有一些不可解决的问题。最大的一个问题是：当输入框内容在 y 轴滚动方向溢出时，浏览器的滚动行为不可控。即使我们使用监听器强制同步输入层与渲染层的滚动位置，也无法完全解决这个问题。当输入框内容溢出时，浏览器其实并不会立即触发滚动事件，这样就会导致输入层与渲染层的滚动位置不同步。

> 体验地址： [https://pzq123456.github.io/example/](https://pzq123456.github.io/example/)
> - 我集成了 Gemini

接下来，如果有时间的话，我会考虑设计数据结构，采用block的方式来存储文本，同时重新设计可控的渲染方式。我会讲内容按照行来分割为多个细小的结构，每一个结构单独管理。同时用户在边缘时，就会首先创建空白的结构，这样就可以避免溢出的问题。

当然，这种解决思路是我从成熟的编辑器中学到的。我或许不会真的去实现这个方案，但是这个方案的思路是值得借鉴的。

## 3. 结论
我之前一直认为使用 Canvas 来实现终端的渲染是一种十分“另类”或者说“非主流”的方法。现在再看，发现竟然为我避免需多“坑”。果然，基于 Canvas 的渲染是一种相对稳定与可控的方案。浏览器的行为在特殊的场景中完全是不可控的，这是我之前没有意识到的。

目前而言，我的终端能够很好地满足我的需求（尤其是自娱自乐方面的）。我并不打算改变现有的方案。但是，我会继续探索新的方案，以便在未来的项目中能够更好地应对各种需求。

